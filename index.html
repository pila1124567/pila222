<!DOCTYPE html>
<html>
<head>
  <title>Live Mirror</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { margin:0; background:#000; font-family:Arial; color:#0f0; text-align:center; }
    #qr { padding:20px; }
    video { width:95%; max-width:900px; border:4px solid #0f0; border-radius:12px; margin:10px; }
    .status { font-size:1.5em; padding:20px; }
  </style>
</head>
<body>
  <div class="status" id="status">Generating room...</div>
  <div id="qr"></div>
  <video id="video" autoplay playsinline controls></video>

  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script>
    const room = location.search ? new URLSearchParams(location.search).get('r') 
                 : Math.random().toString(36).substring(2,12);
    const isViewer = !location.search;
    const signalingURL = 'https://YOUR-SIGNALING-URL.onrender.com'; // â† change this after deploy

    if (isViewer) {
      document.getElementById('status').innerText = 'Scan QR with phone to see their screen';
      new QRCode(document.getElementById('qr'), {
        text: location.origin + location.pathname + '?r=' + room,
        width: 280, height: 280, colorDark: "#0f0", colorLight: "#000"
      });
    } else {
      document.getElementById('status').innerText = 'Connecting... Allow screen sharing';
      document.body.style.background = '#000';
    }

    const pc = new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
    const video = document.getElementById('video');

    pc.ontrack = e => video.srcObject = e.streams[0];

    // Signaling helpers
    async function send(type, data) {
      await fetch(`${signalingURL}/${type}/${room}`, {
        method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)
      });
    }
    async function poll(type) {
      const res = await fetch(`${signalingURL}/${type}/${room}`);
      return res.ok ? res.json() : null;
    }

    if (isViewer) {
      // Viewer creates offer
      pc.onicecandidate = e => e.candidate && send('ice', e.candidate);
      (async () => {
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        await send('offer', offer);
        while (true) {
          const answer = await poll('answer');
          if (answer) { await pc.setRemoteDescription(answer); break; }
          await new Promise(r=>setTimeout(r,1000));
        }
        while (true) {
          const ice = await poll('ice');
          if (ice) await pc.addIceCandidate(ice);
          await new Promise(r=>setTimeout(r,2000));
        }
      })();
    } else {
      // Phone side
      navigator.mediaDevices.getDisplayMedia({video:true, audio:true})
        .then(stream => {
          stream.getTracks().forEach(t => pc.addTrack(t, stream));
          video.srcObject = stream;
          (async () => {
            while (true) {
              const offer = await poll('offer');
              if (offer) {
                await pc.setRemoteDescription(offer);
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                await send('answer', answer);
                break;
              }
              await new Promise(r=>setTimeout(r,1000));
            }
            pc.onicecandidate = e => e.candidate && send('ice', e.candidate);
          })();
        })
        .catch(()=> document.body.innerHTML = "<h1>Screen sharing denied or closed</h1>");
    }
  </script>
</body>
</html>